# Production configuration with AWS RDS
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # Disable local PostgreSQL (using RDS instead)
  postgres:
    image: alpine:latest
    command: echo "Using external RDS database"
    restart: "no"
    deploy:
      replicas: 0

  # Backend - Production Configuration
  backend:
    build:
      context: ./zaban_backend
      dockerfile: Dockerfile.prod
      args:
        HUGGING_FACE_TOKEN: ${HUGGING_FACE_TOKEN:-}
    environment:
      DATABASE_URL: ${DATABASE_URL}
      HUGGING_FACE_TOKEN: ${HUGGING_FACE_TOKEN:-}
      NODE_ENV: production
      PYTHONUNBUFFERED: 1
      # NVIDIA GPU
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on: []
    volumes:
      # Production model caches (host paths for persistence)
      - /data/ml_models/huggingface:/app/.cache/huggingface
      - /data/ml_models/whisper:/root/.cache/whisper
      - /data/ml_models/fasttext:/root/.cache/zaban/models

  # Frontend - Production Configuration  
  frontend:
    environment:
      NEXT_PUBLIC_EXTERNAL_API_URL: ${NEXT_PUBLIC_EXTERNAL_API_URL}
      NODE_ENV: production
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  ml_models_cache:
